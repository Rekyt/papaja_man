# Writing

## Workflow

- Don't edit raw data
- Don't set a working directory
- Generate graphics from R code
- Don't edit word documents
- Relative paths

### Working with a reference manager

- Bib(La)TeX export of Mendeley
- Better Bib(La)TeX integration of citr

If you are not already using a reference manager such as Zotero, I strongly suggest you start doing so. Reference managers are like iTunes for your literature; they help you search, download, and organize papers. Most importantly, with a few clicks you can export a collection of references you need for a paper into a .bib-file. Once your references are in a .bib-file that resides in the same folder as your Markdown-file, you can easily add citations to your Markdown document. Each reference has a unique handle, e.g. lewandowsky_computational_2011, which you can use in Markdown. @lewandowsky_computational_2011 creates an in-text citation; [@lewandowsky_computational_2011] creates a citation in parentheses. Everything reference-related, such as in-text citation and the reference section, will be taken cared of automatically.

- RStudio
  - Section overview
  - Spell check


## Markdown text formatting

<!-- Add examples of most common Markdown syntax -->

<!-- headings, comments, footnotes, images, url -->
<!-- italics, bold, quotation, en- and em-dash, nbsp -->

A comprehensive overview of the supported Markdown syntax is provided by [RStudio's R Markdown documentation](http://rmarkdown.rstudio.com/authoring_pandoc_markdown.html).

<!-- Copy paste from R4DS: -->
<!-- Instead, as you work through this chapter, and use R Markdown in the future, keep these resources close to hand: -->

<!-- - R Markdown Cheat Sheet: Help > Cheatsheets > R Markdown Cheat Sheet, -->

<!-- - R Markdown Reference Guide: Help > Cheatsheets > R Markdown Reference Guide. -->

<!-- Both cheatsheets are also available at http://rstudio.com/cheatsheets. -->

<!-- LaTeX code -->


## Citations

No manuscript is complete without citation.
In order for citations to work, you need to supply a Bib(La)TeX file to the `bibliography` parameter in the YAML front matter (`bibliography: my.bib`).
Once this is done, `[e.g., @james_1890; @bem_2011]` produces a regular citation within parentheses [e.g., @james_1890; @bem_2011].
To cite a source in text simply omit the brackets; for example, write `@james_1890` to cite @james_1890.
For other options see the [overview of the R Markdown citation syntax](http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html).

The citation style is automatically set to APA style.
If you need to use a different citation style, you can set in the YAML front matter by adding a `csl` parameter.
See the [R Markdown documentation](http://R Markdown.rstudio.com/authoring_bibliographies_and_citations.html) and [Citation Style Language](http://citationstyles.org/) for further details.


### Conveniently inserting citations with `citr`

`citr` is an R package that provides functions to search Bib(La)TeX-files to create and insert formatted Markdown citations into the current document.
If you use RStudio, the package supplies an easy-to-use [RStudio add-in](https://rstudio.github.io/rstudioaddins/) that facilitates inserting citations (Figure \@ref(fig:citr-gif)).
The references for the inserted citations are automatically added to the documents reference section.


> Nachdem ich bei Ihnen die erste Übungen mit R unternommen habe, versuche ich mich derzeit in Papaja (unser gesamtes Lehrgebiet eignet sich derzeit Papayja an). Ich habe allerdings noch nicht herausgefunden, wie ich die alphabetische Sortierung ausschalten kann, z.B. für den Fall (Berthold & Meier, 2009; Wright, 2009; but see Alfred & Bert, 2007). Können Sie mir evtl. weiterhelfen?

### Working with a reference manager

```{r citr-gif, echo = FALSE, fig.align = "center", fig.cap = "Demonstration of the RStudio addin from the `citr` package that inserts R Markdown citations."}
knitr::include_graphics("https://raw.githubusercontent.com/crsh/citr/master/inst/images/addin_demo.gif")
```

Once `citr` is installed (`install.packages("citr")`) and you have restarted your R session, the addin appears in the menus and you can define a [keyboard shortcut](https://rstudio.github.io/rstudioaddins/#keyboard-shorcuts) to call the addin.

The addin will automatically look up the Bib(La)TeX-file(s) specified in the YAML front matter.
If the document does not contain a YAML front matter the addin will attempt to locate a parent document and look up the Bib(La)TeX-file specified therein.
That is, the addin works its automagic even if you edit R Markdown documents that are included as [children](http://yihui.name/knitr/demo/child/) in another R Markdown document (also see [Splitting an R Markdown document]).
The expected names of a parent document default to `c("index.Rmd", "master.Rmd")`, it thus works with [`bookdown`](https://bookdown.org/) out of the box, but can be customized (e.g., `options(citr.parent_documents = "my_parent.Rmd")`).


`citr` can also be used without RStudio, albeit it is less convenient.
The following call searches a Bib(La)TeX-file and creates formatted Markdown citations for the results.

```{r citr-without-rstudio, eval = FALSE}
library("citr")
md_cite("foo 2016", bib_file = "references.bib")
```

`md_cite()` searches the author, year, title, and journal fields of your references.

If you are using Zotero or Juris-M `citr` can access your reference database directly.
For this to work, you need to install the [Better Bib(La)TeX extension](https://github.com/retorquere/zotero-better-bibtex/wiki), which I would recommend anyway.
Once the extension is installed and your reference manager is running, `citr` will automatically access all your references and keep your Bib(La)Tex-file updated by adding missing references.
If you dislike this behavior, you can disable it by setting `options(citr.use_betterbiblatex = FALSE)`.


### Referencing R and its packages

I think it is important to credit the software we use.
A lot of R packages are developed by academics free of charge.
As citations are the currency of science, it's easy to compensate volunteers for their work by citing the R packages we use.
I suspect that, among other things, this is rarely done because it is tedious work.
That's why papaja makes citing R and its packages easy:

```{r echo = TRUE}
r_refs(file = "r-references.bib")
my_citation <- cite_r(file = "r-references.bib")
```

`r_refs()` creates a BibTeX file containing citations for R and all currently loaded packages.
`cite_r()` takes these citations and turns them into readily reportable text.
`my_citation` now contains the following text that you can use in your document: `r my_citation`


## Tables

For prettier tables, I suggest you try `apa_table()`, which builds on `knitr`'s `kable()`.

```{r results = 'asis', echo = TRUE, eval = FALSE}
descriptives <- mixed_data %>% group_by(Dosage) %>%
  summarize(
    Mean = mean(Recall)
    , Median = median(Recall)
    , SD = sd(Recall)
    , Min = min(Recall)
    , Max = max(Recall)
  )
descriptives[, -1] <- printnum(descriptives[, -1])

apa_table(
  descriptives
  , caption = "Descriptive statistics of correct recall by dosage."
  , note = "This table was created with apa_table()"
  , escape = TRUE
)
```

Of course popular packages like `xtable`[^xtable] or `tables` can also be used to create tables when knitting PDF documents.
These packages, however, cannot be used when you want to create Microsoft Word documents because they rely on $\LaTeX$ for typesetting.
`apa_table()` creates tables that conform to APA guidelines and are correctly rendered in PDF and Word documents.
But don't get too excited.
In papaja, table formatting is somewhat limited for Word documents due to missing functionality in pandoc (e.g., it is not possible to have cells or headers span across multiple columns).

[^xtable]: When you use `xtable()`, table captions are [set to the left page margin](http://tex.stackexchange.com/questions/42209/centering-tables-in-document-class-apa6).

As required by the APA guidelines, tables are deferred to the final pages of the manuscript when creating a PDF.
To place tables and figures in your text instead, set the `figsintext` parameter in the YAML header to `yes` or `true`, as I have done in this document.
Again, this is not the case in Word documents due to limited pandoc functionality.
The bottom line is, Word documents will be less polished than PDF.
The resulting documents should suffice to enable collaboration with Wordy colleagues and prepare a journal submission with limited manual labor.


```{r results = "asis", include = FALSE, eval = FALSE}
employee <- c("$\\alpha$",'$\\alpha$','$\\alpha$')
salary       <- c(21000, 23400, 26800)
startdate   <- as.Date(c('2010-11-1','2008-3-25','2007-3-14'))
dt              <- data.frame(employee, salary, startdate)

apa_table(
  dt
  , caption = "Descriptive statistics of correct recall by dosage."
  , note      = "This table was created with apa\\_table() and here's
some latex $\\alpha$"
  , escape = FALSE
  , format   = "latex"
)
```

<!-- 1. To use LaTeX code inside a table you have to set escape = FALSE. Otherwise, elements of the LaTeX syntax (such as backslashes) will be printed as is. -->

<!-- 2. If you set escape = FALSE you need to manually escape symbols that would otherwise be interpreted as LaTeX code, such as underscores (see note). -->

<!-- 3. When you pass backslashes as character strings you need to escape the backslash with one additional backslash because R uses backslashes to denote special characters, such as \t for tab or \n for newline, and will interpret \a as newline, I think. The remaining lpha is meaningless in LaTeX math environments and will cause an error. -->

<!-- 4. If you want to write symbols in any part of the table use $ instead of $$, which is used in text to format equations as distinct equations in new inset paragraphs. -->

<!-- (5. format = "latex" is not required if you use the function inside an R Markdown document)  -->


### Alternatives

Pixidust: https://github.com/nutterb/pixiedust/blob/master/README.md

xtable: https://cran.r-project.org/web/packages/xtable/xtable.pdf

tables: https://cran.r-project.org/web/packages/tables/vignettes/tables.pdf

stargazer: https://cran.r-project.org/web/packages/stargazer/index.html

knitr::kable

Hmisc::latex


https://twitter.com/polesasunder/status/464132152347475968/photo/1


## Figures

```{r echo = FALSE}
load("data/mixed_data.rdata")
```


As usual in R Markdown, you can embed R-generated plots into your document, see Figure \@ref(fig:beeswarm).

```{r beeswarm, fig.cap = "Beeswarm plot of the example data set. Small points represent individual observations, large points represent means, and error bars represent 95% within-subjects confidence intervals.", echo = TRUE, dev.args = list(bg = 'white'), fig.width = 8}
apa_beeplot(
  mixed_data
  , id = "Subject"
  , dv = "Recall"
  , factors = c("Task", "Valence", "Dosage")
  , dispersion = wsci
  , level = .95
  , ylim = c(0, 30)
  , las = 1
  , args_points = list(cex = 1)
  , args_arrows = list(length = 0.025)
)
```

Again, as required by the APA guidelines, figures are deferred to the final pages of the document unless you set `figsintext` to `yes`.

`papaja` provides the functions `apa_beeplot`, `apa_lineplot`, and `apa_barplot` to easily plot data from factorial designs (`apa_generic_plot` is the underlying workhorse function).
They are intended to provide a convenient way to obtain a publication-ready figure with easy-to-learn, human-readable and *short* syntax;
while maintaining enough flexibility for a lot of customizing, if you're really into this.
The basic arguments to these functions are all the same, so you only need to learn one syntax to generate these different types of plots.
Moreover, this comes with the additional advantage that you can easily switch between these types of plots by simply replacing some letters in the function call.

A basic usage would look like this:

```{r fig.cap = "Beeswarm plot of the example data set. Small points represent individual observations, large points represent means, and error bars represent 95% confidence intervals.", echo = TRUE, dev.args = list(bg = 'white'), eval = FALSE}
apa_beeplot(
  data = mixed_data
  , id = "Subject"
  , dv = "Recall"
  , factors = c("Task", "Valence", "Dosage")
)
```

The first argument is the `data.frame` that contains the data,
while the other arguments represent character strings identifying the columns that contain the subject identifier `id`,
the dependent variable `dv`,
and the between- or within-subjects `factors`.
Yet, zero to four factors are supported.

Via parameter `tendency`, you can specify any function that will be used to calculate the measure of central tendency.
Via parameter `dispersion`, you can specify any function that will be used to calculate the measure of dispersion.
A little candy: You can also require within-subjects confidence intervals as described by @morey (and we already did in Figure \@ref(fig:beeswarm)).

If you have more than one observation per participant-factor-level-combination, these observations are aggregated.
You can specify individual aggregation functions via `fun_aggregate`.

### What is plotted?

For each cell of the submitted data, the following information is plotted:

- A measure of central tendency.
- A measure of dispersion.
- The names of dependent variable, factors and factor levels; a legend, if necessary.

The plot functions in `papaja` are build around the `graphics` packages that is part of the base distribution of R.
A lot of customization can thus be accomplished by calling `par`.

If you are not willing to change these global options, you can pass a lot of parameters to the underlying functions
by arguments `args_points`, `args_error_bars`, etc. each time you call the plot.
See the below example for a more customized version of a beeswarm plot (\@ref(fig:customized-plot)).

```{r customized-plot, fig.cap = "A customized beeswarm plot. Note that, by default, the swarm inherits parameters from the args_points argument."}
apa_beeplot(
    data = mixed_data
  , id = "Subject"
  , dv = "Recall"
  , factors = c("Task", "Valence", "Dosage")
  , args_points = list(cex = 2, bg = c("skyblue4", "indianred3", "seagreen4"), col = "white")
  , args_swarm = list(cex = 1.2)
  , args_error_bars = list(length = .02, col = "grey20")
  , args_y_axis = list(las = 1)
  , main = c(expression(italic(A)~"dosage"), expression(italic(B)~"dosage"), expression(italic(C)~"dosage"))
  , dispersion = wsci
)
```

A footnote on customization: If you customize the colors in your plots, you *can* use transparency
(i.e., via defining colors with `rgb()`).
However, as soon as you do this, your plots will be included in a pixel-based format in your final document,
even if you knit to pdf (usually, when knitting to pdf, R plots are included in a vector-based format).
Pixel-based plot graphics are not too bad, but may lead to ugly compression artifacts after you uploaded your manuscript to
a manuscript submission system. (We already had that problem in our lab.)

<!-- ### Customization -->

If you prefer creating your plots with `ggplot2` try `theme_apa()`.


## Equations

If you need to report formulas, you can use the flexible $\LaTeX$ syntax (it will work in Word documents, too).
Inline math must be enclosed in `$` or `\(` and `\)` and the result will look like this: $d' = z(\mathrm{H}) - z(\mathrm{FA})$.
For larger formulas displayed equations are more appropriate; they are enclosed in `$$` or `\[`and `\]`,

$$
d' = \frac{\mu_{old} - \mu_{new}}{\sqrt{0.5(\sigma^2_{old} + \sigma^2_{new})}}.
$$

## Cross-referencing

`papaja` builds on the document formats `pdf_document2()` and `word_document2()` from the `bookdown` package.
This enables the use of `bookdown` cross-referencing syntax including automatically generated table and figure labels as detailed in the [bookdown documentation](https://bookdown.org/yihui/bookdown/cross-references.html).

<!-- Add examples -->

## Appendices
