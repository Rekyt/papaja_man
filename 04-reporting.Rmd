# Reporting

Using `papaja`, it is possible to run all your analyses from within an R Markdown document.
This section describes how the results of your analyses can be included in text.

```{r printnum-values, echo = FALSE}
age_mean <- 22.8395
age_sd <- 3.7846237542894
```

Consider a basic example, where you want to include a mean and a standard deviation into text:
The function `printnum()` can be used to include a numeric value into text,
with the correct rounding and with or without a leading zero.
Just write some inline R code like this:

```{r inline-printnum, eval = FALSE, highlight = FALSE}
Participants mean age was `r printnum(age_mean)` years (*SD* = `r printnum(age_sd)`).
```

which will result in: Participants mean age was `r printnum(age_mean)` years (*SD* = `r printnum(age_sd)`).

`printnum()` is quiet flexible and passes its arguments to the underlying base function `formatC()` 
(CAVE: We are currently considering to switch to `format()`.),
so changing the number of digits after the decimal point or the character to be used to indicate the 
decimal point (e.g., from a point `"."` to a comma `","`) is always possible.

The function `printp()` is a shorthand version of `printnum()` with the correct defaults alread set for printing $p$ values
(i.e., printing $p < .001$ instead of this horrible $p = .000$ bullshit).

And btw, if you forget to include `printnum` in your inline code, `papaja` is clever
enough to aumatically call it. Thus, writing

```{r inline-hook, eval = FALSE, highlight = FALSE}
Participants mean age was `r age_mean` years (*SD* = `r age_sd`).
```

also results in: Participants mean age was `r printnum(age_mean)` years (*SD* = `r printnum(age_sd)`).

## Results from statistical tests

Output from statistical models and tests needs to be properly formatted before it
can be included in text.
For this purpose, we created the function `apa_print()`.
Simply drop the results from a statistical test (e.g. a $t$ test or an ANOVA)
into `apa_print()`, and you will get an output object that contains all you need
to report the analysis according to APA guidelines.
`apa_print()` currently supports output objects from a variety of statistical models/tests,
including $t$ tests, ANOVA, linear regression, and many, many more.
For a full list of supported output objects, see Table \@ref(tab:supported-s3-methods).





```{r formatting-process-diagram, fig.cap = "Process diagram illustrating the use of `apa_print()` methods and `apa_table()` to format results from statistical analyses according to APA guidelines. The formatted text and tables can be reported in a manuscript.", fig.align = "center", echo = FALSE}
# grViz("
# digraph reporting_process {
#   graph [rankdir = TB, fontname = Helvetica, ranksep = 0.8, overlap = FALSE]
# 
#   node [shape = box, fontname = Helvetica, margin = 0.2]
# 
#   # Input
#   format [label = 'rmarkdown.pandoc.to']
#   table [label = '$table']
# 
#   subgraph cluster_0 {
#     htest [label = 'htest']
#     lm [label = 'lm']
#     aov [label = 'aov\naovlist\nafex_aov\nAnova.mlm']
#     anova [label = 'anova']
# 
#     style = rounded
#     label = 'Analysis results (S3-objects)'
#   }
#   
#   # apa_print output
#   subgraph cluster_1 {
#     estimate [label = '$estimate']
#     statistic [label = '$statistic']
#     full [label = '$full']
# 
#     style = rounded
#     label = 'Formatted text'
#     labelloc = 'b'
#   }
# 
#   # Output
#   l_table [label = 'LaTeX table']
#   p_table [label = 'pandoc table']
# 
#   # papaja functions
#   node [shape = diamond, margin = 0.1]
#   apa_print [label = 'apa_print.class()']
#   apa_table [label = 'apa_table()']
# 
#   # Transitions
#   edge [fontname = Helvetica, fontsize = 15, arrowhead = vee]
#   {htest lm aov anova} -> apa_print -> {estimate statistic full table}
#   {table format} -> apa_table -> {l_table p_table}
# }
# ")

knitr::include_graphics("result_formatting_process.png")
```

### htest (*t* tests, correlations, etc.)

The results of a $t$ test (regardless of the exact type of $t$ test) are typically stored in an `htest` object.



### lm (linear regression)
#### anova (model comparisons)

### anova, Anova, Anova.mlm (Analysis of Variance -- ANOVA)

*Foreword -- you can skip this if you are not interested in background*.
Amongst psychologists, analysis of variance is a still-popular and frequently used technique.
In base R, however, analysis of variance is not implemented in a way that is too useful
for psychologists, as the `aov`function in the stats package does not provide the much sought-after
Type-$\rm{I\!I\!I}$ sums-of-squares. A  variety of R packages has emerged to fill the gap, e.g. the
`car` [@R-car], `ezANOVA` [@R-ezANOVA], and `afex` [@R-afex]. The problem is: All ANOVA functions provide
different output objects (and using `summary` on these objects generates even other objects) that need to be digested by `apa_print()`.
Even though we spent quiet some work on `apa_print()` taking everything from ANOVA, there are still some shortcomings: 
Output objects from `ezANOVA` are not supported, as they do not contain the necessary information to be properly digested.

*Functionality*.

#### glht, lsmeans, ref.grid (post-hoc tests)




The functions `apa_print()` and `apa_table()` facilitate reporting results of your analyses. Take a look at the [.Rmd](https://github.com/crsh/papaja/blob/master/example/example.Rmd) of the example manuscript in the folder `example` and the resulting [.pdf](https://raw.githubusercontent.com/crsh/papaja/master/example/example.pdf).

Drop a supported analysis result, such as an `htest`- or `lm`-object, into `apa_print()` and receive a list of possible character strings that you can use to report the results of your analysis.

```{r}
my_lm <- lm(Sepal.Width ~ Sepal.Length + Petal.Width + Petal.Length, data = iris)
apa_lm <- apa_print(my_lm)
```

One element of this list is `apa_lm$table` that, in the case of an `lm`-object, will contain a complete regression table. Pass `apa_lm$table` to `apa_table()` to turn it into a proper table in your PDF or Word document (remember to set the chunk option `results = "asis"`).

```{r results = "asis"}
apa_table(apa_lm$table, caption = "Iris regression table.")
```

<!-- GitHub markdown doesn't support MathJax

---

Table. *Iris regression table.*

| Predictor     | *b*   | 95% CI          | *t(146)*   | *p*       |
|:--------------|:-----:|:---------------:|:----------:|:---------:|
| Intercept     | 1.04  |  [0.51, 1.58]   | 3.85       | &lt; .001 |
| Sepal Length  | 0.61  |  [0.48, 0.73]   | 9.77       | &lt; .001 |
| Petal Width   | 0.56  |  [0.32, 0.80]   | 4.55       | &lt; .001 |
| Petal Length  | -0.59 |  [-0.71, -0.46] | -9.43      | &lt; .001 |

---
-->

`papaja` currently provides methods for the following object classes:

```{r supported-s3-methods, echo = FALSE, results = "asis"}
print_classes <- gsub("apa_print\\.", "", as.character(utils::methods("apa_print")))
print_classes <- c(print_classes, rep(NA,  length(print_classes) %% 4))
print_classes <- matrix(print_classes, ncol = 4)
colnames(print_classes) <- apply(print_classes, 2, function(x) {
  first_letters <- tolower(substr(x, 1, 1))
  first_letters <- c(first_letters[1], tail(first_letters, 1))
  first_letters[is.na(first_letters)] <- "z"
  col_names <- if(first_letters[1] == first_letters[2]) first_letters[1] else paste(first_letters, collapse = "-")
  toupper(col_names)
})
knitr::kable(print_classes, caption = "Object types that are currently supported by `apa_print()`.")
```



Any output from R is included as you usually would using R Markdown.
By default the R code will not be displayed in the final documents.
If you wish to show off your code you need to set `echo = TRUE` in the chunk options.


### Report statistical analyses

`apa_print()` will help you report the results of your statistical analyses.
The function will format the contents of R objects and produce readily reportable text.

```{r echo = TRUE, eval = FALSE}
recall_anova <- afex::aov_car(
  Recall ~ (Task * Valence * Dosage) + Error(Subject/(Task * Valence)) + Dosage
  , data = mixed_data
  , type = 3
)
recall_anova_results <- apa_print(recall_anova, es = "pes")
recall_anova_results_p <- apa_print(recall_anova, es = "pes", in_paren = TRUE)
```

Now, you can report the results of your analyses like so:

```{r eval = FALSE, echo = TRUE, eval = FALSE}
Item valence (`r anova_results_p$full$Valence`) and the task affected recall
performance, `r anova_results$full$Task`; the dosage, however, had no effect
on recall, `r anova_results$full$Dosage`. There was no significant interaction.
```

<!--
> Item valence (`r #recall_anova_results_p$full$Valence`) and the task affected recall performance, `r #recall_anova_results$full$Task`;
> the dosage, however, had no effect on recall, `r #recall_anova_results$full$Dosage`.
> There was no significant interaction.
-->

What's even more fun, you can easily create a complete ANOVA table by passing `recall_anova_results$table` to `apa_table()`, see \autoref{ref:anova}.

```{r results = "asis", echo = TRUE, eval = FALSE}
apa_table(
  recall_anova_results$table
  , align = c("l", "r", "c", "r", "r", "r")
  , caption = "ANOVA table for the analyis of the example data set. \\label{ref:anova}"
  , note = "This is a table created using apa\\_print() and apa\\_table()."
)
```



## Caching
