# Reporting

Using `papaja`, it is possible to run all your analyses from within an R Markdown document.
Any output from R is included as you usually would using R Markdown.
By default the R code will not be displayed in the final documents.
If you wish to show off your code you need to set `echo = TRUE` in the chunk options.

This section describes how you can include the results of your analyses can be included in text.
It starts with simple numerical values (like a sample mean) and then continues with more-complex
output, like the results from statistical models and hypothesis tests.
`papaja` comes with two functions (`printnum` and `apa_print`) that do the job of formatting
everything according to APA guidelines.


## Numerical values

```{r printnum-values, echo = FALSE}
age_mean <- 22.8395
age_sd <- 3.7846237542894
```

Consider a basic example, where you want to include a mean and a standard deviation into text:
The function `printnum()` can be used to include a numeric value into text,
with the correct rounding and with or without a leading zero.
Just write some inline R code like this:

```{r inline-printnum, eval = FALSE, highlight = FALSE}
Participants mean age was `r printnum(age_mean)` years (*SD* = `r printnum(age_sd)`).
```

which will result in: Participants mean age was `r printnum(age_mean)` years (*SD* = `r printnum(age_sd)`).

`printnum()` is quiet flexible and passes its arguments to the underlying base function `formatC()` 
(CAVE: We are currently considering to switch to `format()`.),
so changing the number of digits after the decimal point or the character to be used to indicate the 
decimal point (e.g., from a point `"."` to a comma `","`) is always possible.

`papaja` applies `printnum` to any numbers that a printed in inline code chunks.
Thus, writing

```{r inline-hook, eval = FALSE, highlight = FALSE}
Participants mean age was `r age_mean` years (*SD* = `r age_sd`).
```

also results in: Participants mean age was `r printnum(age_mean)` years (*SD* = `r printnum(age_sd)`).

The function `printp()` is a shorthand version of `printnum()` with the correct defaults alread set for printing $p$ values
(i.e., printing $p < .001$ instead of the incorrect $p = .000$).


## Results from statistical tests

Output from statistical models and tests needs to be properly formatted before it
can be included in text.
For this purpose, we created the function `apa_print()`.
Simply drop the results from a statistical test (e.g. a $t$ test or an ANOVA)
into `apa_print()`, and you will get an output object (a `list`) that contains all you need
to report the analysis according to APA guidelines.
`apa_print()` currently supports output objects from a variety of statistical models/tests,
including $t$ tests, ANOVA, linear regression.
For a full list of supported output objects, see Table \@ref(tab:supported-s3-methods).


```{r supported-s3-methods, echo = FALSE, results = "asis"}
print_classes <- gsub("apa_print\\.", "", as.character(utils::methods("apa_print")))
print_classes <- print_classes[!grepl(",", print_classes)]
print_classes <- c(print_classes, rep(NA,  (4 - length(print_classes) %% 4) * (length(print_classes) %% 4 > 0)))
print_classes <- matrix(print_classes, ncol = 4)
colnames(print_classes) <- apply(print_classes, 2, function(x) {
  first_letters <- tolower(substr(x, 1, 1))
  first_letters <- c(first_letters[1], tail(first_letters, 1))
  first_letters[is.na(first_letters)] <- "z"
  col_names <- if(first_letters[1] == first_letters[2]) first_letters[1] else paste(first_letters, collapse = "-")
  toupper(col_names)
})
print_classes[is.na(print_classes)] <- ""
knitr::kable(print_classes, caption = "Analysis object types currently supported by `apa_print()`.")
```


```{r formatting-process-diagram, fig.cap = "Process diagram illustrating the use of `apa_print()` methods and `apa_table()` to format results from statistical analyses according to APA guidelines. The formatted text and tables can be reported in a manuscript.", fig.align = "center", echo = FALSE}
# grViz("
# digraph reporting_process {
#   graph [rankdir = TB, fontname = Helvetica, ranksep = 0.8, overlap = FALSE]
# 
#   node [shape = box, fontname = Helvetica, margin = 0.2]
# 
#   # Input
#   format [label = 'rmarkdown.pandoc.to']
#   table [label = '$table']
# 
#   subgraph cluster_0 {
#     htest [label = 'htest']
#     lm [label = 'lm']
#     aov [label = 'aov\naovlist\nafex_aov\nAnova.mlm']
#     anova [label = 'anova']
# 
#     style = rounded
#     label = 'Analysis results (S3-objects)'
#   }
#   
#   # apa_print output
#   subgraph cluster_1 {
#     estimate [label = '$estimate']
#     statistic [label = '$statistic']
#     full [label = '$full']
# 
#     style = rounded
#     label = 'Formatted text'
#     labelloc = 'b'
#   }
# 
#   # Output
#   l_table [label = 'LaTeX table']
#   p_table [label = 'pandoc table']
# 
#   # papaja functions
#   node [shape = diamond, margin = 0.1]
#   apa_print [label = 'apa_print.class()']
#   apa_table [label = 'apa_table()']
# 
#   # Transitions
#   edge [fontname = Helvetica, fontsize = 15, arrowhead = vee]
#   {htest lm aov anova} -> apa_print -> {estimate statistic full table}
#   {table format} -> apa_table -> {l_table p_table}
# }
# ")

knitr::include_graphics("result_formatting_process.png")
```


### htest (*t* tests, correlations, etc.)

The results of a $t$ test (regardless of the exact type of $t$ test) are typically stored in an `htest` object.

```{r}
# Cosmetic surgery dataset from
# Field, A. P., Miles, J., & Field, Z. (2012). Discovering statistics using R. London: Sage.
load("data/cosmetic_surgery.rdata")

t_out <- t.test(
  x = cosmetic_surgery$Post_QoL
  , y = cosmetic_surgery$Base_QoL
  , paired = TRUE
)

# Let's see what the apa_print() output looks like
apa_print(t_out)
```

As you can see, `apa_print()` returns a list of four elements:
List element `estimate` contains the sample estimate of mean difference;
element `statistic` contains the result of the NHST with test statistic, *df*s, and *p* value;
element `full_result` contains both information combined.
The fourth element, `table`, contains a table containing test results; while this is `NULL` for a $t$ test,
it will be quiet interesting for ANOVA or linear model results, as you will see in the next subsections.

### lm (linear regression)

The results of a linear model are stored in an `lm` object.

```{r}
lm_out <- lm(formula = Post_QoL ~ Base_QoL + BDI, data = cosmetic_surgery)
apa_lm <- apa_print(lm_out)
```

Again, `apa_print` returns a four-elements list.
`apa_lm$table` contains a complete regression table that can be passed to `apa_table()` to get a full regression table, see Table \@ref(tab:lm-table; remember to set the chunk option `results = "asis"`).

```{r lm-table, results = "asis"}
apa_table(
  apa_lm$table
  , caption = "A full regression table."
  , escape = FALSE
)
```

#### anova (model comparisons)

...

### anova, Anova, Anova.mlm (Analysis of Variance -- ANOVA)

*Foreword -- you can skip this if you are not interested in background*.
Amongst psychologists, analysis of variance is a still-popular and frequently used technique.
In base R, however, analysis of variance is not implemented in a way that is too useful
for psychologists, as the `aov`-function in the stats package does not provide the much sought-after
Type-$\rm{I\!I\!I}$ sums-of-squares. A variety of R packages has emerged to fill the gap, e.g.
`car` [@R-car], `ez` [@R-ez], and `afex` [@R-afex].
Unfortunately, each ANOVA function provides different output objects that need to be digested by `apa_print()`.
To do so, we rely on the package authors to return standardized result objects (i.e., S3/S4 classes).
For this reason `apa_print()` does not support results from the popular `ezANOVA()`.
The object returned by this function has no class to inform us about its contents and, thus, cannot be processed.
We recommend you try one of the other available packages, e.g. `aov_ez()` from the `afex`-package.

*Functionality*.

```{r anova-apa, message = FALSE}
cosmetic_surgery_anova <- afex::aov_ez(
  data = cosmetic_surgery
  , dv = "Post_QoL"
  , id = "ID"
  , between = c("Clinic", "Gender")
)
apa_anova <- apa_print(cosmetic_surgery_anova)
```

Now, you can report the results of your analyses like so:

```{r eval = FALSE, echo = TRUE, eval = FALSE}
Clinic (`r apa_anova$full$Clinic`) and patient gender affected post-surgery quality of life, `r apa_anova$full$Gender`. However, the effect of gender differed by clinic, `r apa_anova$full$Clinic_Gender`.
```

Which will yield the following text:

> Clinic (`r apa_anova$full$Clinic`) and patient gender affected post-surgery quality of life, `r apa_anova$full$Gender`. However, the effect of gender differed by clinic, `r apa_anova$full$Clinic_Gender`.

Again, you can easily create a complete ANOVA table by passing `recall_anova_results$table` to `apa_table()`, see \autoref{ref:anova}.

```{r anova-table, results = 'asis'}
apa_table(
  apa_anova$table
  , caption = "A really beautiful ANOVA table."
  , note = "Note that the column names contain beautiful mathematical copy: This is because the table has variable labels."
)
```



#### glht, lsmeans, ref.grid (post-hoc tests)

...



## Caching expensive computations

...
